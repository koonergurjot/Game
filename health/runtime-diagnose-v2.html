<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Runtime Diagnosis v2 · Gurjot's Games</title>
<style>
  :root { --ok:#0a0; --fail:#c00; --warn:#b58900; --muted:#666; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
  h1 { margin: 0 0 8px; }
  .meta { color: var(--muted); margin-bottom: 16px; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #e5e7eb; padding: 8px; vertical-align: top; }
  th { background: #f8fafc; text-align: left; }
  iframe { width: 420px; height: 280px; border: 1px solid #ddd; background:#fff; }
  .status { font-weight: 600; }
  .OK { color: var(--ok); }
  .FAIL { color: var(--fail); }
  .WARN { color: var(--warn); }
  .muted { color: var(--muted); }
  details { margin-top: 4px; }
  summary { cursor: pointer; }
  .controls { display:flex; gap:8px; margin: 12px 0 20px; flex-wrap: wrap; }
  button, select { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; background:#fff; cursor:pointer; }
  button:hover { background:#f3f4f6; }
  code.badge { background:#eef2ff; padding:2px 6px; border-radius:6px; margin-left:8px; }
</style>
</head>
<body>
<h1>Runtime Diagnosis v2 <code class="badge">uses game.html</code></h1>
<div class="meta">This checker loads each game via <code>game.html?slug=&lt;slug&gt;</code> (same as production). If you still see fails for games that are playable, you may be looking at an older cached diagnostics page. Use the buttons below.</div>
<div class="controls">
  <button id="kill-sw">Kill SW</button>
  <button id="reload-all">Reload All</button>
  <button id="clear-logs">Clear Logs</button>
  <button id="force-nocache">Force No-Cache</button>
  <label><input type="checkbox" id="forceLegacy" /> Force legacy&nbsp;&nbsp; Shell:
    <select id="shell">
      <option value="game.html">game.html (prod)</option>
      <option value="play.html">play.html (alt)</option>
    </select>
  </label>
</div>
<table id="report">
  <thead>
    <tr>
      <th style="width:160px">Game</th>
      <th style="width:460px">Preview</th>
      <th style="width:120px">Status</th>
      <th>Details</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
const tbody = document.querySelector('#report tbody');
const mk = (t, props={}) => Object.assign(document.createElement(t), props);

const VERSION_MARK = 'diagnostics-v2-uses-gamehtml';

// Try to disable SW cache for this page
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations?.().then(list => {
    list.forEach(r => r.update());
  });
}

async function loadCatalog() {
  const tryFetch = async (url) => {
    try {
      const r = await fetch(url + (url.includes('?') ? '&' : '?') + 'diag_v=2&cb=' + Date.now(), { cache: 'no-store' });
      if (!r.ok) throw new Error('status ' + r.status);
      const j = await r.json();
      return Array.isArray(j) ? j : [];
    } catch (_) { return []; }
  };
  // Prefer root, fallback to /data
  const root = location.pathname.replace(/\/health\/.*$/, '/');
  const primary = await tryFetch(root + 'games.json');
  const fallback = await tryFetch(root + 'data/games.json');
  // Union by slug
  const map = new Map();
  for (const g of [...primary, ...fallback]) {
    if (g && g.slug) map.set(g.slug, g);
  }
  const list = Array.from(map.values());
  // expose count
  window.__diag_catalog_info = { primaryCount: primary.length, fallbackCount: fallback.length, total: list.length };
  return list;
}


// Kill SW handler
document.getElementById('kill-sw')?.addEventListener('click', async () => {
  if (!('serviceWorker' in navigator)) return;
  const regs = await navigator.serviceWorker.getRegistrations();
  for (const r of regs) { try { await r.unregister(); } catch(_){} }
  alert('Service workers unregistered. Hard refresh recommended.');
});


function buildRows(list, shell='game.html', forceNoCache=false) {
  tbody.innerHTML = '';
  const sorted = [...list].sort((a,b)=>a.slug.localeCompare(b.slug));
  for (const g of sorted) {
    const tr = mk('tr');
    const name = mk('td');
    const iframeCell = mk('td');
    const status = mk('td', { className: 'status muted', textContent: 'PENDING' });
    const details = mk('td');
    tbody.appendChild(tr);
    tr.append(name, iframeCell, status, details);

    name.innerHTML = `<div><strong>${g.title || g.slug}</strong><div class="muted">${g.slug}</div></div>`;

    const root = (location.pathname.replace(/\/health\/.*$/, "/")); const url = root + `${shell}?slug=${encodeURIComponent(g.slug)}&diag_v=2&cb=${Date.now()}`;
    const open = mk('a', { href: url, textContent: 'Open', target: '_blank', rel: 'noopener' });
    const iframe = mk('iframe');
    iframe.referrerPolicy = 'no-referrer';
    if (forceNoCache) {
      iframe.loading = 'eager';
    }
    if (document.getElementById('forceLegacy')?.checked) { url += '&legacy=1'; open.href = url; }
    iframe.src = url;
    iframeCell.append(iframe, mk('div', { style:'margin-top:6px' , appendChild: open }));

    const logs = [];
    const log = (msg) => { logs.push(msg); renderDetails(); };
    const setStatus = (cls, txt) => { status.className = 'status ' + cls; status.textContent = txt; };

    let ready = false;
    let syntheticReady = false;
    const timer = setTimeout(() => {
      if (!ready) {
        if (syntheticReady) {
          setStatus('WARN','SYNTHETIC READY—waiting for real signal');
          log('No real GAME_READY/ERROR after synthetic postMessage within 6s');
        } else {
          setStatus('WARN','NO SIGNAL');
          log('No GAME_READY/ERROR postMessage within 6s');
        }
      }
    }, 10000);

    function renderDetails() {
      details.innerHTML = `<details ${logs.length ? 'open':''}><summary>logs (${logs.length})</summary><pre>${logs.join('\n')}</pre></details>`;
    }

    window.addEventListener('message', (ev)=>{
      if (ev.source !== iframe.contentWindow || !ev.data || typeof ev.data !== 'object') return;
      const d = ev.data;
      if (d.slug !== g.slug) return;
      if (d.type === 'GAME_READY') {
        if (d.synthetic) {
          syntheticReady = true;
          setStatus('WARN','SYNTHETIC READY—waiting for real signal');
          log('GAME_READY (synthetic)');
          return;
        }
        ready = true;
        clearTimeout(timer);
        setStatus('OK','OK');
        log('GAME_READY');
      }
      if (d.type === 'GAME_ERROR') {
        ready = true;
        clearTimeout(timer);
        setStatus('FAIL', (d.message? ('FAIL — ' + d.message) : 'FAIL'));
        log('GAME_ERROR: ' + (d.message || ''));
      }
    });

    iframe.addEventListener('error', () => {
      clearTimeout(timer);
      setStatus('FAIL','IFRAME LOAD ERROR');
      log('iframe onerror fired');
    });
    iframe.addEventListener('load', () => {
      log('iframe loaded');
    });
  }
}

const shellSel = document.getElementById('shell');
document.getElementById('reload-all').addEventListener('click', ()=>{
  const frames = document.querySelectorAll('iframe');
  frames.forEach(f => {
    const url = new URL(f.src, location.origin);
    url.searchParams.set('cb', String(Date.now()));
    f.src = url.toString();
  });
});
document.getElementById('clear-logs').addEventListener('click', ()=>{
  const pres = document.querySelectorAll('td details pre');
  pres.forEach(p => p.textContent = '');
});
document.getElementById('force-nocache').addEventListener('click', ()=>{
  loadCatalog().then(list => buildRows(list, shellSel.value, true));
});
shellSel.addEventListener('change', ()=>{
  loadCatalog().then(list => buildRows(list, shellSel.value));
});

loadCatalog().then(list => buildRows(list, shellSel.value)).catch(err => {
  tbody.innerHTML = `<tr><td colspan="4" class="muted">Failed to load games.json: ${err && err.message || err}</td></tr>`;
});
</script>
</body>
</html>
