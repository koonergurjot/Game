<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Play — Gurjot’s Games</title>
  <style>
    :root { --bg:#0b0f14; --card:#121821; --muted:#9db0c5; --accent:#4cc9f0; --error:#ff6b6b; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: linear-gradient(180deg, #0b0f14, #111827 35%, #0b0f14);
      color: #e5f0ff; font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: grid; grid-template-rows: auto 1fr auto; gap: 8px;
    }
    header, footer {
      backdrop-filter: blur(6px); background: rgba(17,24,39,0.6); border-bottom: 1px solid #243042;
    }
    header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; }
    header .title { display:flex; align-items:center; gap:10px; }
    header .title h1 { font-size: 16px; margin: 0; font-weight: 600; }
    header nav { display:flex; gap:8px; }
    a.btn, button.btn {
      appearance: none; border: 1px solid #2a3b54; background: #0f1622; color: #e5f0ff;
      padding: 8px 10px; border-radius: 10px; cursor: pointer; text-decoration: none;
    }
    a.btn:hover, button.btn:hover { border-color: #3b5172; }
    main { display:grid; place-items:center; padding: 8px; }
    .game-card {
      width: min(1280px, 100%); aspect-ratio: 16/9; background: #0b0f14; border: 1px solid #1e2a3b;
      border-radius: 14px; overflow: clip; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.45);
    }
    iframe#game-frame { width: 100%; height: 100%; border: 0; background: #000; display:block; }
    .overlay {
      position:absolute; inset:0; display:grid; place-items:center; pointer-events:none;
    }
    .status {
      pointer-events:auto; background: rgba(12,18,28,0.92); border:1px solid #223049; border-radius:12px;
      padding:16px; width:min(560px, 90%);
    }
    .status h2 { margin:0 0 6px; font-size:16px; }
    .status p { margin:6px 0 0; color: var(--muted); }
    .row { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .pill { border:1px solid #2a3b54; padding:6px 8px; border-radius:999px; font-size:12px; color:#cfe2ff; }
    .logbox {
      margin-top:10px; max-height:160px; overflow:auto; background:#0b1018; border:1px solid #203049; border-radius:8px; padding:8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px;
    }
    .hidden { display:none; }
    footer { padding: 10px 14px; border-top: 1px solid #243042; color: #a8c3df; }
    @media (max-width: 768px) {
      header .title h1 { font-size: 14px; }
      .game-card { aspect-ratio: 3/4; }
    }
  </style>
</head>
<body>
  <header aria-label="Game Shell Header">
    <div class="title">
      <a id="backLink" class="btn" href="./index.html" aria-label="Back to home">← Back</a>
      <h1 id="gameTitle">Loading…</h1>
    </div>
    <nav>
      <button id="btnReload" class="btn" aria-label="Reload game">Reload</button>
      <button id="btnDiag" class="btn" aria-label="Show diagnostics">Diagnostics</button>
    </nav>
  </header>

  <main>
    <section class="game-card" aria-live="polite">
      <iframe id="game-frame" title="Game frame" sandbox="allow-scripts allow-same-origin allow-pointer-lock"></iframe>
      <div class="overlay" id="overlay">
        <div class="status" id="statusPanel">
          <h2 id="statusTitle">Starting…</h2>
          <p id="statusText">We’re booting the game. First load may take a bit longer.</p>
          <div class="row">
            <span class="pill" id="pillSlug">slug: —</span>
            <span class="pill" id="pillTimer">t+0.0s</span>
            <span class="pill" id="pillSignal">signal: —</span>
          </div>
          <div class="logbox" id="logbox" role="log" aria-live="polite"></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    Standard shell + diagnostics active. Press <strong>Diagnostics</strong> to copy details.
  </footer>

  <script>
    (function () {
      const qs = new URLSearchParams(location.search);
      let slug = (qs.get("slug") || "").trim();
      const title = qs.get("title") || "";
      const gameTitleEl = document.getElementById("gameTitle");
      const frame = document.getElementById("game-frame");
      const overlay = document.getElementById("overlay");
      const statusTitle = document.getElementById("statusTitle");
      const statusText = document.getElementById("statusText");
      const pillSlug = document.getElementById("pillSlug");
      const pillTimer = document.getElementById("pillTimer");
      const pillSignal = document.getElementById("pillSignal");
      const logbox = document.getElementById("logbox");
      const btnReload = document.getElementById("btnReload");
      const btnDiag = document.getElementById("btnDiag");

      // Normalize 2048 → g2048 (keeps existing links working)
      if (slug === "2048") slug = "g2048";

      // Fallback title
      gameTitleEl.textContent = title || (slug ? slug.replace(/[-_]/g, " ") : "Unknown Game");

      // Helper: log
      const t0 = performance.now();
      function secs() { return ((performance.now() - t0) / 1000).toFixed(1) + "s"; }
      function setTimer() { pillTimer.textContent = "t+" + secs(); }
      setInterval(setTimer, 100);

      function write(line) {
        const ts = secs();
        const msg = `[${ts}] ${line}`;
        const div = document.createElement("div");
        div.textContent = msg;
        logbox.appendChild(div);
        logbox.scrollTop = logbox.scrollHeight;
      }

      // Wire buttons
      btnReload.addEventListener("click", () => {
        write("manual: reload requested");
        frame.contentWindow?.location.reload();
      });
      btnDiag.addEventListener("click", () => {
        const payload = [
          `slug=${slug}`, `title=${gameTitleEl.textContent}`, `signal=${pillSignal.textContent.replace("signal: ","")}`,
          `time=${secs()}`, `userAgent=${navigator.userAgent}`, `href=${location.href}`,
          `logs:`, ...Array.from(logbox.querySelectorAll("div")).map(d => "- " + d.textContent)
        ].join("\n");
        navigator.clipboard.writeText(payload).catch(()=>{});
        btnDiag.textContent = "Copied!";
        setTimeout(()=>btnDiag.textContent="Diagnostics", 1200);
      });

      // Load the game iframe
      pillSlug.textContent = "slug: " + (slug || "—");

      function setFrameSrc(src, note) {
        frame.src = src;
        write(`iframe src set → ${src}${note ? ` (${note})` : ""}`);
      }

      if (!slug) {
        setFrameSrc("./404.html");
      } else {
        const modernSrc = `./gameshells/${slug}/index.html`;
        const legacySrc = `./games/${slug}/index.html`;

        write(`checking modern wrapper → ${modernSrc}`);

        const forceLegacy = qs.has('legacy') || qs.get('shell') === 'legacy';
        const forceModern = qs.has('modern') || qs.get('shell') === 'modern';
        if (forceLegacy) {
          setFrameSrc(legacySrc, "forced legacy");
        } else if (forceModern) {
          setFrameSrc(modernSrc, "forced modern");
        } else {
        fetch(modernSrc, { method: "HEAD" })
          .then((resp) => {
            if (resp.ok) {
              setFrameSrc(modernSrc, "modern wrapper");
            } else {
              setFrameSrc(legacySrc, `legacy fallback (status ${resp.status})`);
            }
          })
          .catch((err) => {
            setFrameSrc(legacySrc, `legacy fallback (${err && err.message ? err.message : err})`);
          });
        }
      }


      frame.addEventListener("load", () => {
        write("iframe loaded");
        try {
          const mark = frame.contentWindow && frame.contentWindow.__gg_autoSignalInstalled;
          write("child autosignal: " + (mark ? "present" : "absent/x-origin"));
        } catch (e) {
          write("child-access error (likely cross-origin): " + (e && e.message ? e.message : e));
        }
      });


      // Signal handling
      let signalled = false;
      window.addEventListener("message", (ev) => {
        if (ev.source !== frame.contentWindow) return;
        const data = ev.data;
        if (!data || typeof data !== "object") return;
        if (data.type === "GAME_READY") {
          signalled = true;
          pillSignal.textContent = "signal: GAME_READY";
          statusTitle.textContent = "Ready";
          statusText.textContent = "Have fun!";
          overlay.classList.add("hidden");
          write("signal: GAME_READY");
        } else if (data.type === "GAME_ERROR") {
          signalled = true;
          pillSignal.textContent = "signal: GAME_ERROR";
          statusTitle.textContent = "Oops, this game didn't load.";
          statusText.textContent = data.error ? String(data.error) : "Check the console for details.";
          overlay.classList.remove("hidden");
          write("signal: GAME_ERROR " + (data.error || ""));
        }
      });

      // Timeout if no signal in 6s
      setTimeout(() => {
        if (!signalled) {
          pillSignal.textContent = "signal: (none)";
          statusTitle.textContent = "No signal from game";
          statusText.textContent = "We didn’t receive GAME_READY/ERROR within 6 seconds. The game may still be loading or failed silently.";
          overlay.classList.remove("hidden");
          write("timeout: no GAME_READY/ERROR within 6s");
        }
      }, 6000);

      // Bubble up errors from shell too
      window.addEventListener("error", (e) => write("shell error: " + (e.message || e.error || e)));
      window.addEventListener("unhandledrejection", (e) => write("shell rejection: " + (e.reason || e)));
    })();
  </script>
</body>
</html>
