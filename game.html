<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Play — Gurjot’s Games</title>
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <style>
    :root { --bg:#0b0f14; --card:#121821; --muted:#9db0c5; --accent:#4cc9f0; --error:#ff6b6b; --font-brand:"Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: linear-gradient(180deg, #0b0f14, #111827 35%, #0b0f14);
      color: #e5f0ff; font-size: 14px; line-height: 1.5; font-family: var(--font-brand);
      display: grid; grid-template-columns: minmax(0, 1fr); grid-template-rows: auto auto 1fr auto; gap: 8px;
      grid-template-areas:
        "header"
        "quest"
        "main"
        "footer";
    }
    body.legacy-shell {
      display: block;
      background: #000;
    }
    header, footer {
      backdrop-filter: blur(6px); background: rgba(17,24,39,0.6); border-bottom: 1px solid #243042;
    }
    header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; grid-area: header; }
    header .title { display:flex; align-items:center; gap:10px; }
    header .title h1 { font-size: 16px; margin: 0; font-weight: 600; }
    header nav { display:flex; gap:8px; }
    a.btn, button.btn {
      appearance: none; border: 1px solid #2a3b54; background: #0f1622; color: #e5f0ff;
      padding: 8px 10px; border-radius: 10px; cursor: pointer; text-decoration: none;
    }
    a.btn:hover, button.btn:hover { border-color: #3b5172; }
    main { display:grid; place-items:stretch; padding: 0; grid-area: main; }
    .game-card {
      width: 100%; height: 100%; aspect-ratio: auto; background: #0b0f14; border: 1px solid #1e2a3b;
      border-radius: 14px; overflow: clip; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.45);
    }
    body.legacy-shell .game-card {
      border: 0;
      border-radius: 0;
      box-shadow: none;
    }
    iframe#game-frame { width: 100%; height: 100%; border: 0; background: #000; display:block; }
    .overlay {
      position:absolute; inset:0; display:grid; place-items:center; pointer-events:none;
    }
    body.legacy-shell header,
    body.legacy-shell footer,
    body.legacy-shell .overlay {
      display: none !important;
    }
    body.legacy-shell main {
      padding: 0;
      height: 100vh;
      display: block;
    }
    body.legacy-shell iframe#game-frame {
      height: 100vh;
    }
    .status {
      pointer-events:none; background: rgba(12,18,28,0.92); border:1px solid #223049; border-radius:12px;
      padding:16px; width:min(560px, 90%);
      color:#f3f7ff;
    }
    .status .logbox { pointer-events:auto; }
    .status h2 { margin:0 0 6px; font-size:16px; }
    .status p { margin:6px 0 0; color: var(--muted); }
    .row { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .pill { border:1px solid #2a3b54; padding:6px 8px; border-radius:999px; font-size:12px; color:#cfe2ff; }
    .logbox {
      margin-top:10px; max-height:160px; overflow:auto; background:#0b1018; border:1px solid #203049; border-radius:8px; padding:8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px;
    }
    .hidden { display:none; }
    footer { padding: 10px 14px; border-top: 1px solid #243042; color: #a8c3df; grid-area: footer; }
    #questWidgetRoot {
      grid-area: quest;
    }
    .quest-widget {
      padding: 0 14px;
    }
    .quest-widget-panel {
      background: rgba(12,18,28,0.92);
      border: 1px solid #223049;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      display: grid;
      gap: 12px;
    }
    .quest-widget-heading {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }
    .quest-widget-xp-total {
      margin: 0;
      font-size: 13px;
      color: var(--muted);
    }
    .quest-widget-group {
      display: grid;
      gap: 8px;
    }
    .quest-widget-subheading {
      margin: 0;
      font-size: 14px;
      color: #d3e6ff;
    }
    .quest-widget-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 8px;
    }
    .quest-widget-item {
      border: 1px solid rgba(76,201,240,0.25);
      border-radius: 10px;
      padding: 10px 12px;
      background: rgba(15,22,34,0.8);
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .quest-widget-item:focus-visible {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(76,201,240,0.35);
    }
    .quest-widget-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-weight: 600;
    }
    .quest-widget-label {
      font-size: 14px;
    }
    .quest-widget-xp {
      font-size: 12px;
      color: #4cc9f0;
      font-weight: 600;
    }
    .quest-widget-progress {
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      margin-top: 8px;
      overflow: hidden;
      position: relative;
    }
    .quest-widget-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4cc9f0, #4895ef);
    }
    .quest-widget-status {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .quest-widget-item.is-complete {
      border-color: #4cc9f0;
      background: rgba(76,201,240,0.12);
    }
    .quest-widget-item.is-complete .quest-widget-status {
      color: #7ae0ff;
      font-weight: 600;
    }
    .quest-widget-empty {
      text-align: center;
      color: var(--muted);
      font-style: italic;
    }
    .quest-widget-note {
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--muted);
    }
    body.legacy-shell .quest-widget {
      display: none;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
      white-space: nowrap;
    }
    @media (max-width: 768px) {
      header .title h1 { font-size: 14px; }
    }
    @media (min-width: 1024px) {
      body {
        grid-template-columns: minmax(0, 1fr) minmax(0, 320px);
        grid-template-areas:
          "header header"
          "main quest"
          "footer footer";
      }
      .quest-widget {
        align-self: start;
        justify-self: start;
        width: 100%;
        max-width: 320px;
      }
    }
  </style>
</head>
<body>
  <header aria-label="Game Shell Header">
    <div class="title">
      <a id="backLink" class="btn" href="./index.html" aria-label="Back to home">← Back</a>
      <h1 id="gameTitle">Loading…</h1>
    </div>
    <nav>
      <button id="btnReload" class="btn" aria-label="Reload game">Reload</button>
      <button id="btnDiag" class="btn" aria-label="Show diagnostics">Diagnostics</button>
    </nav>
  </header>

  <section id="questWidgetRoot" class="quest-widget" aria-live="polite"></section>

  <main>
    <section class="game-card" aria-live="polite">
      <iframe id="game-frame" title="Game frame" sandbox="allow-scripts allow-same-origin allow-pointer-lock"></iframe>
      <div class="overlay" id="overlay" aria-hidden="false">
        <div class="status" id="statusPanel" role="status" aria-live="polite" aria-atomic="true">
          <span class="sr-only" id="statusContext">Game status message</span>
          <h2 id="statusTitle" aria-describedby="statusContext">Starting…</h2>
          <p id="statusText">We’re booting the game. First load may take a bit longer.</p>
          <div class="row">
            <span class="pill" id="pillSlug">slug: —</span>
            <span class="pill" id="pillTimer">t+0.0s</span>
            <span class="pill" id="pillSignal">signal: —</span>
          </div>
          <div class="logbox" id="logbox" role="log" aria-live="polite"></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    Standard shell + diagnostics active. Press <strong>Diagnostics</strong> to copy details.
  </footer>

  <script src="./js/auto-diag-inject.js"></script>

  <script type="module">
    import { mountQuestWidget } from './shared/quest-widget.js';
    const root = document.getElementById('questWidgetRoot');
    if (root) {
      mountQuestWidget(root, { headingLevel: 2, regionLabel: 'Quest progress tracker' });
    }
  </script>

  <script>
    (function () {
      const qs = new URLSearchParams(location.search);
      let slug = (qs.get("slug") || "").trim();
      const title = qs.get("title") || "";
      const gameTitleEl = document.getElementById("gameTitle");
      const frame = document.getElementById("game-frame");
      const overlay = document.getElementById("overlay");
      const statusTitle = document.getElementById("statusTitle");
      const statusText = document.getElementById("statusText");
      const statusPanel = document.getElementById("statusPanel");
      const pillSlug = document.getElementById("pillSlug");
      const pillTimer = document.getElementById("pillTimer");
      const pillSignal = document.getElementById("pillSignal");
      const logbox = document.getElementById("logbox");
      const btnReload = document.getElementById("btnReload");
      const btnDiag = document.getElementById("btnDiag");

      let isLegacyShell = false;

      const diagHandler = () => {
        const payload = [
          `slug=${slug}`, `title=${gameTitleEl.textContent}`, `signal=${pillSignal.textContent.replace("signal: ","")}`,
          `time=${secs()}`, `userAgent=${navigator.userAgent}`, `href=${location.href}`,
          `logs:`, ...Array.from(logbox.querySelectorAll("div")).map(d => "- " + d.textContent)
        ].join("\n");
        navigator.clipboard.writeText(payload).catch(()=>{});
        btnDiag.textContent = "Copied!";
        setTimeout(()=>btnDiag.textContent="Diagnostics", 1200);
      };

      let diagWired = false;
      function wireDiagButton() {
        if (!btnDiag) return;
        if (!diagWired) {
          btnDiag.addEventListener("click", diagHandler);
          diagWired = true;
        }
        btnDiag.classList.remove("hidden");
        btnDiag.removeAttribute("aria-hidden");
        btnDiag.removeAttribute("tabindex");
      }

      function unwireDiagButton() {
        if (!btnDiag) return;
        if (diagWired) {
          btnDiag.removeEventListener("click", diagHandler);
          diagWired = false;
        }
        btnDiag.classList.add("hidden");
        btnDiag.setAttribute("aria-hidden", "true");
        btnDiag.setAttribute("tabindex", "-1");
        btnDiag.textContent = "Diagnostics";
      }

      // Normalize 2048 → g2048 (keeps existing links working)
      if (slug === "2048") slug = "g2048";

      // Fallback title
      gameTitleEl.textContent = title || (slug ? slug.replace(/[-_]/g, " ") : "Unknown Game");

      // Helper: log
      const t0 = performance.now();
      function secs() { return ((performance.now() - t0) / 1000).toFixed(1) + "s"; }
      function setTimer() { pillTimer.textContent = "t+" + secs(); }
      setInterval(setTimer, 100);

      function write(line) {
        const ts = secs();
        const msg = `[${ts}] ${line}`;
        const div = document.createElement("div");
        div.textContent = msg;
        logbox.appendChild(div);
        logbox.scrollTop = logbox.scrollHeight;
      }

      // Wire buttons
      btnReload.addEventListener("click", () => {
        write("manual: reload requested");
        frame.contentWindow?.location.reload();
      });
      // Load the game iframe
      pillSlug.textContent = "slug: " + (slug || "—");

      function setFrameSrc(src, note, legacy = false) {
        frame.src = src;
        isLegacyShell = legacy;
        if (legacy) {
          unwireDiagButton();
        } else {
          wireDiagButton();
        }
        write(`iframe src set → ${src}${note ? ` (${note})` : ""}`);
      }

      if (!slug) {
        setFrameSrc("./404.html");
      } else {
        const modernSrc = `./gameshells/${slug}/index.html`;
        const legacySrc = `./games/${slug}/index.html`;

        write(`checking modern wrapper → ${modernSrc}`);

        const forceLegacy = qs.has('legacy') || qs.get('shell') === 'legacy';
        const forceModern = qs.has('modern') || qs.get('shell') === 'modern';
        if (forceLegacy) {
          setFrameSrc(legacySrc, "forced legacy", true);
        } else if (forceModern) {
          setFrameSrc(modernSrc, "forced modern", false);
        } else {
        fetch(modernSrc, { method: "HEAD" })
          .then((resp) => {
            if (resp.ok) {
              setFrameSrc(modernSrc, "modern wrapper", false);
            } else {
              setFrameSrc(legacySrc, `legacy fallback (status ${resp.status})`, true);
            }
          })
          .catch((err) => {
            setFrameSrc(legacySrc, `legacy fallback (${err && err.message ? err.message : err})`, true);
          });
        }
      }


      frame.addEventListener("load", () => {
        write("iframe loaded");
        if (isLegacyShell) {
          document.body.classList.add("legacy-shell");
          unwireDiagButton();
        } else {
          document.body.classList.remove("legacy-shell");
          wireDiagButton();
        }
        try {
          const mark = frame.contentWindow && frame.contentWindow.__gg_autoSignalInstalled;
          write("child autosignal: " + (mark ? "present" : "absent/x-origin"));
        } catch (e) {
          write("child-access error (likely cross-origin): " + (e && e.message ? e.message : e));
        }
      });


      // Signal handling
      let signalled = false;
      window.addEventListener("message", (ev) => {
        if (ev.source !== frame.contentWindow) return;
        const data = ev.data;
        if (!data || typeof data !== "object") return;
        if (data.type === "GAME_READY") {
          signalled = true;
          pillSignal.textContent = "signal: GAME_READY";
          statusTitle.textContent = "Ready";
          statusText.textContent = "Have fun!";
          overlay.classList.add("hidden");
          overlay.setAttribute("aria-hidden", "true");
          if (statusPanel) statusPanel.setAttribute("aria-hidden", "true");
          write("signal: GAME_READY");
        } else if (data.type === "GAME_ERROR") {
          signalled = true;
          pillSignal.textContent = "signal: GAME_ERROR";
          statusTitle.textContent = "Oops, this game didn't load.";
          statusText.textContent = data.error ? String(data.error) : "Check the console for details.";
          overlay.classList.remove("hidden");
          overlay.setAttribute("aria-hidden", "false");
          if (statusPanel) statusPanel.setAttribute("aria-hidden", "false");
          write("signal: GAME_ERROR " + (data.error || ""));
        }
      });

      // Timeout if no signal in 6s
      setTimeout(() => {
        if (!signalled) {
          pillSignal.textContent = "signal: (none)";
          statusTitle.textContent = "No signal from game";
          statusText.textContent = "We didn’t receive GAME_READY/ERROR within 6 seconds. The game may still be loading or failed silently.";
          overlay.classList.remove("hidden");
          overlay.setAttribute("aria-hidden", "false");
          if (statusPanel) statusPanel.setAttribute("aria-hidden", "false");
          write("timeout: no GAME_READY/ERROR within 6s");
        }
      }, 6000);

      // Bubble up errors from shell too
      window.addEventListener("error", (e) => write("shell error: " + (e.message || e.error || e)));
      window.addEventListener("unhandledrejection", (e) => write("shell rejection: " + (e.reason || e)));
    })();
  </script>
</body>
</html>
