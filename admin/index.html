<!doctype html>
<html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin â€” Gurjot's Games</title>
<link rel="stylesheet" href="../css/styles.css"/>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>body{padding:18px}.row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}textarea{width:100%;height:46vh;border-radius:12px;background:var(--bg-soft);color:var(--text);border:1px solid var(--card-border);padding:12px;font-family:ui-monospace,menlo,consolas}.drop{padding:18px;border:2px dashed var(--card-border);border-radius:12px;text-align:center;margin:14px 0}.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin:10px 0}.mini{background:var(--bg-soft);border:1px solid var(--card-border);border-radius:12px;padding:10px}.mini h4{margin:4px 0 6px}.pill{font-size:.8rem;padding:4px 8px;border-radius:999px;border:1px solid var(--card-border);background:var(--chip);color:var(--text)}.hide{display:none}.import-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}.import-actions small{flex:1;opacity:.8}.preview-shell{display:none;margin-top:10px;border:1px solid var(--card-border);border-radius:10px;overflow:hidden;position:relative;background:var(--bg);min-height:210px;box-shadow:0 10px 30px rgba(0,0,0,0.18)}.preview-shell.active{display:block}.preview-shell iframe{width:100%;height:210px;border:0;background:#000}.preview-shell .preview-close{position:absolute;top:8px;right:8px;z-index:2;padding:6px 10px;font-size:.85rem}.preview-placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.9rem;background:linear-gradient(135deg,rgba(132,90,223,0.12),rgba(132,90,223,0.04));color:var(--text-muted,#9ba0b8);text-align:center;padding:12px}.preview-shell:not(.active) .preview-placeholder{display:none}.editor-shell{display:flex;flex-wrap:wrap;gap:18px;margin-top:16px}.editor-shell aside,.editor-shell section,.editor-shell .json-pane{flex:1 1 280px;min-width:260px}.editor-shell aside{max-width:320px;background:var(--bg-soft);border:1px solid var(--card-border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:12px}.editor-shell aside header{display:flex;justify-content:space-between;align-items:center;gap:8px}.editor-shell aside h3{margin:0;font-size:1rem}.editor-shell aside .list{display:flex;flex-direction:column;gap:6px;overflow-y:auto;max-height:46vh;padding-right:4px}.game-row{border:1px solid var(--card-border);border-radius:10px;padding:10px;cursor:pointer;background:var(--bg-soft);display:flex;flex-direction:column;gap:8px;transition:border-color .15s,background .15s}.game-row:hover{border-color:var(--primary)}.game-row.selected{border-color:var(--primary);background:rgba(132,90,223,0.12)}.game-row .meta{display:flex;flex-wrap:wrap;gap:6px;font-size:.75rem}.badge{padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--card-border);text-transform:uppercase;letter-spacing:.05em}.editor-shell section{border:1px solid var(--card-border);border-radius:12px;padding:16px;background:var(--bg-soft);min-height:46vh}.editor-shell section h3{margin-top:0}.editor-shell section form{display:flex;flex-direction:column;gap:12px}.editor-shell section label{font-weight:600;display:block;margin-bottom:6px}.editor-shell section input[type="text"],.editor-shell section textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--card-border);background:var(--bg);color:var(--text);font-family:inherit}.editor-shell section textarea{min-height:120px;font-family:inherit}.flag-grid{display:flex;flex-wrap:wrap;gap:10px}.flag-grid label{font-weight:400;display:flex;align-items:center;gap:6px}.json-pane label{font-weight:600;display:block;margin-bottom:8px}.json-pane textarea{height:46vh}.validation-panel{margin-top:16px;border:1px solid var(--card-border);border-radius:12px;background:var(--bg-soft);padding:16px;display:flex;flex-direction:column;gap:12px}.validation-panel[hidden]{display:none}.validation-panel h3{margin:0;font-size:1rem}.validation-header{display:flex;flex-wrap:wrap;align-items:center;gap:12px;justify-content:space-between}.validation-summary{margin:0;font-weight:600}.validation-summary[data-tone="success"]{color:var(--success-color,#3ad29f)}.validation-summary[data-tone="warning"]{color:var(--warning-color,#f0b429)}.validation-summary[data-tone="error"]{color:var(--error-color,#ff4d4f)}.validation-summary[data-tone="info"]{color:var(--text-muted,#9ba0b8)}.validation-docs details{background:var(--bg);border:1px solid var(--card-border);border-radius:10px;padding:10px}.validation-docs summary{cursor:pointer;font-weight:600}.validation-docs ul{margin:8px 0 0;padding-left:20px;opacity:0.9;line-height:1.5}.validation-results{display:flex;flex-direction:column;gap:12px;max-height:42vh;overflow-y:auto;padding-right:4px}.validation-empty{padding:12px;border:1px dashed var(--card-border);border-radius:10px;background:var(--bg);font-size:.9rem;opacity:0.9}.validation-game{border:1px solid var(--card-border);border-radius:12px;padding:12px;background:var(--bg)}.validation-game__header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px}.validation-game__title{display:flex;flex-direction:column;gap:2px}.validation-game__title strong{font-size:1rem}.validation-game__meta{font-size:.8rem;opacity:0.8}.validation-label{display:inline-block;font-size:.8rem;font-weight:600;margin:4px 0}.validation-label.error{color:var(--error-color,#ff4d4f)}.validation-label.warning{color:var(--warning-color,#f0b429)}.validation-messages{margin:0;padding-left:20px}.validation-messages li{margin:4px 0}.validation-actions{display:flex;gap:8px;flex-wrap:wrap}</style>
</head>
<body>
<h2>Admin / CMS</h2>
<div class="status info">Hidden editor for <code>games.json</code>, ZIP import, and patch export.</div>
<div class="row" style="margin-top:12px">
  <a class="btn" href="diagnostics.html">Diagnostics</a>
  <a class="btn" href="../health/index.html" target="_blank">Health Tools</a>
  <a class="btn primary" href="health.html">Health Dashboard</a>
</div>
<div class="row" style="margin-top:10px">
  <button class="btn" id="load">Load games.json</button>
  <button class="btn" id="validate">Validate</button>
  <button class="btn" id="backup">Download backup</button>
  <button class="btn primary" id="saveJson">Download updated games.json</button>
  <button class="btn" id="exportPatch">Download patch ZIP</button>
</div>
<div class="validation-panel" id="validationPanel" hidden>
  <div class="validation-header">
    <h3>Validation</h3>
    <p class="validation-summary" id="validationSummary" data-tone="info" aria-live="polite">Run validation to check each game and its assets.</p>
  </div>
  <div class="validation-docs">
    <details>
      <summary>What gets checked?</summary>
      <ul>
        <li>Required fields: <code>id</code>, <code>title</code>, <code>path</code>, and <code>description</code>.</li>
        <li>Game paths must stay under <code>games/</code>; thumbnails should live under <code>assets/thumbs/</code>.</li>
        <li>Live checks use <code>HEAD</code> requests to confirm <code>path</code> and <code>thumb</code> respond without 404s.</li>
        <li>Optional UI helpers (<code>tags</code>, <code>new</code>, <code>emoji</code>, <code>addedAt</code>) are validated and warned when missing or malformed.</li>
      </ul>
    </details>
  </div>
  <div class="validation-results" id="validationResults" aria-live="polite" aria-label="Validation results"></div>
</div>

<div class="editor-shell">
  <aside id="gameList" aria-label="Game list"></aside>
  <section id="gameEditor" aria-live="polite"></section>
  <div class="json-pane">
    <label for="editor">Raw JSON</label>
    <textarea id="editor" name="editor" spellcheck="false" placeholder="Click 'Load games.json' or paste JSON here"></textarea>
  </div>
</div>
<div class="drop" id="drop"><strong>Drag & drop a game ZIP here</strong><br/>Must contain an <code>index.html</code>. Optional: <code>thumb.png</code>/<code>thumbnail.png</code>.</div>
<div class="grid" id="imports"></div>
<script>
const ed=document.getElementById('editor');const imports=document.getElementById('imports');const gameList=document.getElementById('gameList');const editorPanel=document.getElementById('gameEditor');const validationPanel=document.getElementById('validationPanel');const validationSummary=document.getElementById('validationSummary');const validationResults=document.getElementById('validationResults');const validateBtn=document.getElementById('validate');let pendingAdds=[];let games=[];let selectedIndex=null;let syncingTextarea=false;const flagFields=['new','beta','featured','hidden','unlisted'];
const ABSOLUTE_PATTERN=/^(?:[a-z][a-z0-9+.-]*:|\/\/|#)/i;function toAbsoluteUrl(value){if(typeof value!=='string')return null;const trimmed=value.trim();if(!trimmed)return null;try{return new URL(trimmed,location.origin).href;}catch(e){try{return new URL(trimmed,location.href).href;}catch{return null;}}}
function resolveZipPath(path,prefix){const base=(prefix||'');try{const normalized=new URL(path,'https://preview/'+base+'index.html');const pathname=decodeURIComponent(normalized.pathname.replace(/^\//,''));return{path:pathname,search:normalized.search||'',hash:normalized.hash||''}}catch{return{path:(base+path).replace(/^\//,''),search:'',hash:''}}}
function isSkippableResource(val){return !val||ABSOLUTE_PATTERN.test(val.trim())||/^data:/i.test(val.trim())}
async function createBlobUrl(record,val,state,token){if(state.token!==token)return null;const {path,search,hash}=resolveZipPath(val,record.prefix);let file=record.zip.file(path);if(!file&&record.prefix&&path.startsWith(record.prefix)){file=record.zip.file(path.slice(record.prefix.length))}if(!file&&record.prefix){const fallback=(record.prefix.replace(/\/?$/,'/')+val).replace(/^\//,'');file=record.zip.file(fallback)}if(!file||state.token!==token)return null;const blob=await file.async('blob');if(state.token!==token)return null;const url=URL.createObjectURL(blob);state.urls.push(url);return url+search+hash}
async function rewriteSrcset(record,el,state,token){if(state.token!==token)return;const raw=el.getAttribute('srcset');if(!raw)return;const parts=raw.split(',');const next=[];for(const part of parts){const trimmed=part.trim();if(!trimmed)continue;const segments=trimmed.split(/\s+/);const ref=segments.shift();if(!ref)continue;if(isSkippableResource(ref)){next.push(trimmed);continue}const blobUrl=await createBlobUrl(record,ref,state,token);if(state.token!==token)return;if(blobUrl)next.push([blobUrl,...segments].join(' '))}if(next.length)el.setAttribute('srcset',next.join(', '))}
async function loadPreviewIntoFrame(record,frame,state,placeholder,token){state.cleanup();if(state.token!==token)return;const htmlFile=record.zip.file(record.prefix+'index.html')||record.zip.file('index.html');if(!htmlFile)throw new Error('index.html missing');const htmlText=await htmlFile.async('string');if(state.token!==token){state.cleanup();return}const parser=new DOMParser();const doc=parser.parseFromString(htmlText,'text/html');const selectors=[[doc.querySelectorAll('[src]'),'src'],[doc.querySelectorAll('link[href]'),'href'],[doc.querySelectorAll('[poster]'),'poster'],[doc.querySelectorAll('object[data]'),'data']];for(const [nodeList,attr] of selectors){for(const el of nodeList){if(state.token!==token){state.cleanup();return}if(!el||!el.getAttribute)continue;const raw=el.getAttribute(attr);if(isSkippableResource(raw))continue;if(attr==='href'&&el.tagName==='A')continue;const blobUrl=await createBlobUrl(record,raw,state,token);if(state.token!==token){state.cleanup();return}if(blobUrl)el.setAttribute(attr,blobUrl)}}const svgUses=[...doc.querySelectorAll('[xlink\\:href]')];for(const el of svgUses){if(state.token!==token){state.cleanup();return}const raw=el.getAttribute('xlink:href');if(isSkippableResource(raw))continue;const blobUrl=await createBlobUrl(record,raw,state,token);if(state.token!==token){state.cleanup();return}if(blobUrl)el.setAttribute('xlink:href',blobUrl)}const srcsetEls=[...doc.querySelectorAll('img[srcset],source[srcset]')];for(const el of srcsetEls){if(state.token!==token){state.cleanup();return}await rewriteSrcset(record,el,state,token)}if(state.token!==token){state.cleanup();return}frame.srcdoc='<!doctype html>'+doc.documentElement.outerHTML;placeholder.hidden=true}
const escapeHTML=str=>String(str??'').replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
function syncTextarea(){syncingTextarea=true;ed.value=JSON.stringify(games,null,2);syncingTextarea=false}function focusEditorForIndex(idx,{scroll=true}={}){const targetIndex=Number(idx);if(!Number.isFinite(targetIndex)||targetIndex<0||Math.floor(targetIndex)!==targetIndex||targetIndex>=games.length){return;}selectedIndex=targetIndex;renderList();renderEditor();if(scroll){requestAnimationFrame(()=>{const target=editorPanel.querySelector('form')||editorPanel;target.scrollIntoView({behavior:'smooth',block:'start'});});}}function ensureValidationPanel(){validationPanel.hidden=false;}function setValidationSummary(text,tone='info'){ensureValidationPanel();validationSummary.textContent=text;validationSummary.dataset.tone=tone;}function resetValidationResults(message){validationResults.innerHTML='';if(message){const box=document.createElement('div');box.className='validation-empty';box.textContent=message;validationResults.appendChild(box);}}function renderValidationReport(results){if(!Array.isArray(results)){setValidationSummary('Validation finished.','info');resetValidationResults('No report available.');return;}const totals=results.reduce((acc,res)=>{acc.errors+=res.errors.length;acc.warnings+=res.warnings.length;if(res.errors.length||res.warnings.length)acc.issues++;return acc;},{errors:0,warnings:0,issues:0});let tone='success';let summary='All '+results.length+' game'+(results.length===1?'':'s')+' look good.';if(totals.errors>0){tone='error';summary='Found '+totals.errors+' error'+(totals.errors===1?'':'s')+' and '+totals.warnings+' warning'+(totals.warnings===1?'':'s')+' across '+totals.issues+' game'+(totals.issues===1?'':'s')+'.';}else if(totals.warnings>0){tone='warning';summary='Validation complete with '+totals.warnings+' warning'+(totals.warnings===1?'':'s')+' across '+totals.issues+' game'+(totals.issues===1?'':'s')+'.';}setValidationSummary(summary,tone);validationResults.innerHTML='';if(!totals.issues){const ok=document.createElement('div');ok.className='validation-empty';ok.textContent='No issues found. âœ…';validationResults.appendChild(ok);return;}results.forEach(res=>{if(!res.errors.length&&!res.warnings.length)return;const card=document.createElement('article');card.className='validation-game';const header=document.createElement('div');header.className='validation-game__header';const titleWrap=document.createElement('div');titleWrap.className='validation-game__title';const title=document.createElement('strong');title.textContent=res.displayName;titleWrap.appendChild(title);const meta=document.createElement('span');meta.className='validation-game__meta';meta.textContent='ID: '+(res.id||'â€”')+' â€¢ Entry #'+(res.index+1);titleWrap.appendChild(meta);header.appendChild(titleWrap);const actions=document.createElement('div');actions.className='validation-actions';const editBtn=document.createElement('button');editBtn.type='button';editBtn.className='btn';editBtn.textContent='Edit';editBtn.addEventListener('click',()=>{focusEditorForIndex(res.index,{scroll:true});});actions.appendChild(editBtn);header.appendChild(actions);card.appendChild(header);if(res.errors.length){const label=document.createElement('div');label.className='validation-label error';label.textContent='Errors';card.appendChild(label);const list=document.createElement('ul');list.className='validation-messages';res.errors.forEach(msg=>{const li=document.createElement('li');li.textContent=msg;list.appendChild(li);});card.appendChild(list);}if(res.warnings.length){const label=document.createElement('div');label.className='validation-label warning';label.textContent='Warnings';card.appendChild(label);const list=document.createElement('ul');list.className='validation-messages';res.warnings.forEach(msg=>{const li=document.createElement('li');li.textContent=msg;list.appendChild(li);});card.appendChild(list);}validationResults.appendChild(card);});}function recordResourceIssue(result,severity,message){(severity==='warning'?result.warnings:result.errors).push(message);}async function verifyResource(result,resource){const {field,url,raw,severity}=resource;if(!url)return;try{let res=await fetch(url,{method:'HEAD',cache:'no-store'});if(res.status===405||res.status===501){res=await fetch(url,{method:'GET',cache:'no-store'});}if(!res.ok){const statusText=res.statusText?` ${res.statusText}`:'';recordResourceIssue(result,severity,`${field} responded with ${res.status}${statusText} (${raw})`);}}catch(err){recordResourceIssue(result,severity,`${field} request failed (${raw}): ${err.message}`);}}async function verifyResources(results){for(const result of results){if(!Array.isArray(result.resources))continue;for(const resource of result.resources){await verifyResource(result,resource);}delete result.resources;}}
function renderList(){gameList.innerHTML='';const header=document.createElement('header');const title=document.createElement('h3');title.textContent='Games';header.appendChild(title);const btnWrap=document.createElement('div');btnWrap.className='row';btnWrap.style.margin='0';btnWrap.style.gap='8px';const addBtn=document.createElement('button');addBtn.id='addGame';addBtn.className='btn';addBtn.type='button';addBtn.textContent='Add game';addBtn.onclick=()=>{const stamp=Date.now();let baseId='new-game-'+stamp;let inc=1;while(games.some(g=>g.id===baseId)){baseId='new-game-'+(stamp+inc++);}const newGame={id:baseId,title:'New Game',path:`games/${baseId}/index.html`,description:'',tags:[],emoji:'ðŸŽ®',new:true,addedAt:new Date().toISOString().slice(0,10)};games=[...games,newGame];focusEditorForIndex(games.length-1);syncTextarea();};const dupBtn=document.createElement('button');dupBtn.id='duplicateGame';dupBtn.className='btn';dupBtn.type='button';dupBtn.textContent='Duplicate game';dupBtn.onclick=()=>{if(selectedIndex===null){alert('Select a game to duplicate first.');return}const base=games[selectedIndex];const clone=JSON.parse(JSON.stringify(base));let baseId=base.id+'-copy';let inc=1;while(games.some(g=>g.id===baseId)){baseId=base.id+'-copy'+inc++;}clone.id=baseId;clone.path=base.path.replace(base.id,clone.id);clone.addedAt=new Date().toISOString().slice(0,10);games=[...games,clone];focusEditorForIndex(games.length-1);syncTextarea();};btnWrap.appendChild(addBtn);btnWrap.appendChild(dupBtn);header.appendChild(btnWrap);gameList.appendChild(header);const list=document.createElement('div');list.className='list';if(!games.length){const empty=document.createElement('p');empty.textContent='Load a JSON file to see games.';empty.style.margin='12px 0 0';empty.style.opacity='0.8';gameList.appendChild(empty)}games.forEach((game,idx)=>{const row=document.createElement('div');row.className='game-row'+(idx===selectedIndex?' selected':'');row.dataset.index=idx;const nameLine=document.createElement('div');nameLine.style.display='flex';nameLine.style.justifyContent='space-between';nameLine.style.alignItems='center';const name=document.createElement('strong');name.textContent=`${game.emoji||''} ${game.title||game.id}`.trim();nameLine.appendChild(name);const idLabel=document.createElement('span');idLabel.className='pill';idLabel.textContent=game.id;nameLine.appendChild(idLabel);row.appendChild(nameLine);const meta=document.createElement('div');meta.className='meta';const statuses=[];if(Array.isArray(game.tags)){game.tags.filter(Boolean).forEach(tag=>statuses.push(tag))}flagFields.forEach(flag=>{if(game[flag])statuses.push(flag)});if(statuses.length){statuses.forEach(st=>{const badge=document.createElement('span');badge.className='badge';badge.textContent=st;meta.appendChild(badge)})}if(meta.childElementCount)row.appendChild(meta);row.onclick=()=>{focusEditorForIndex(idx,{scroll:false});};list.appendChild(row)});gameList.appendChild(list)}
function renderEditor(){
  if(selectedIndex===null||!games[selectedIndex]){
    editorPanel.innerHTML='<p>Select a game to edit its details.</p>';
    return;
  }
  const game=games[selectedIndex];
  editorPanel.innerHTML='';
  const heading=document.createElement('h3');
  heading.textContent=`Editing: ${game.title||game.id}`;
  editorPanel.appendChild(heading);
  const form=document.createElement('form');
  const createField=(id,labelText,type='input')=>{
    const wrap=document.createElement('div');
    const label=document.createElement('label');
    label.setAttribute('for',id);
    label.textContent=labelText;
    wrap.appendChild(label);
    const control=document.createElement(type==='textarea'?'textarea':'input');
    control.id=id;
    if(type!=='textarea'){control.type='text';}
    wrap.appendChild(control);
    return {wrap,control};
  };
  const {wrap:titleWrap,control:titleInput}=createField('gameTitle','Title');
  titleInput.value=game.title||'';
  const {wrap:descWrap,control:descTextarea}=createField('gameDescription','Description','textarea');
  descTextarea.value=game.description||'';
  const {wrap:emojiWrap,control:emojiInput}=createField('gameEmoji','Emoji');
  emojiInput.maxLength=4;
  emojiInput.value=game.emoji||'';
  const {wrap:tagsWrap,control:tagsInput}=createField('gameTags','Tags (comma separated)');
  tagsInput.value=Array.isArray(game.tags)?game.tags.join(', '):'';
  form.appendChild(titleWrap);
  form.appendChild(descWrap);
  form.appendChild(emojiWrap);
  form.appendChild(tagsWrap);
  const flagHeading=document.createElement('p');
  flagHeading.textContent='Flags';
  flagHeading.style.width='100%';
  flagHeading.style.fontWeight='600';
  flagHeading.style.margin='0';
  const flagWrap=document.createElement('div');
  flagWrap.className='flag-grid';
  flagWrap.setAttribute('role','group');
  flagWrap.setAttribute('aria-label','Flags');
  form.appendChild(flagHeading);
  form.appendChild(flagWrap);
  flagFields.forEach(flag=>{
    const wrap=document.createElement('label');
    const box=document.createElement('input');
    box.type='checkbox';
    box.checked=Boolean(game[flag]);
    box.addEventListener('change',()=>{
      game[flag]=box.checked;
      renderList();
      syncTextarea();
    });
    wrap.appendChild(box);
    wrap.append(flag.charAt(0).toUpperCase()+flag.slice(1));
    flagWrap.appendChild(wrap);
  });
  const idInfo=document.createElement('div');
  idInfo.innerHTML=`<strong>ID:</strong> ${escapeHTML(game.id)}`;
  const pathInfo=document.createElement('div');
  pathInfo.innerHTML=`<strong>Path:</strong> ${escapeHTML(game.path||'')}`;
  form.appendChild(idInfo);
  form.appendChild(pathInfo);
  if(!pendingAdds.some(it=>it.id===game.id)&&game.id){
    const liveRow=document.createElement('div');
    liveRow.className='row';
    liveRow.style.margin='4px 0 0';
    liveRow.style.gap='10px';
    const liveLink=document.createElement('a');
    liveLink.className='btn';
    liveLink.href=`../games/${encodeURIComponent(game.id)}/`;
    liveLink.target='_blank';
    liveLink.rel='noopener';
    liveLink.textContent='Open live page â†—';
    liveRow.appendChild(liveLink);
    form.appendChild(liveRow);
  }
  editorPanel.appendChild(form);
  titleInput.addEventListener('input',()=>{
    game.title=titleInput.value;
    renderList();
    syncTextarea();
  });
  descTextarea.addEventListener('input',()=>{
    game.description=descTextarea.value;
    syncTextarea();
  });
  emojiInput.addEventListener('input',()=>{
    game.emoji=emojiInput.value;
    renderList();
    syncTextarea();
  });
  tagsInput.addEventListener('input',()=>{
    game.tags=tagsInput.value.split(',').map(t=>t.trim()).filter(Boolean);
    renderList();
    syncTextarea();
  });
}
function loadGamesFromTextarea(){try{const arr=JSON.parse(ed.value);if(Array.isArray(arr)){const prevId=selectedIndex!==null&&games[selectedIndex]?games[selectedIndex].id:null;games=arr;selectedIndex=prevId?arr.findIndex(g=>g.id===prevId):-1;if(selectedIndex<0)selectedIndex=arr.length?0:null;renderList();renderEditor();}}catch(e){}}
ed.addEventListener('input',()=>{if(syncingTextarea)return;loadGamesFromTextarea();});
document.getElementById('load').onclick=async()=>{const res=await fetch('../games.json',{cache:'no-store'});games=await res.json();selectedIndex=games.length?0:null;renderList();renderEditor();syncTextarea();alert('Loaded games.json')};
validateBtn.addEventListener('click',async()=>{const originalLabel=validateBtn.textContent;validateBtn.disabled=true;validateBtn.textContent='Validatingâ€¦';setValidationSummary('Validating gamesâ€¦','info');resetValidationResults('Checking JSON structureâ€¦');try{let arr;try{arr=JSON.parse(ed.value);}catch(err){setValidationSummary('Invalid JSON: '+err.message,'error');resetValidationResults('Fix the JSON and try again.');return;}if(!Array.isArray(arr)){setValidationSummary('Root must be an array.','error');resetValidationResults('games.json should contain an array of game objects.');return;}const prevId=selectedIndex!==null&&games[selectedIndex]?games[selectedIndex].id:null;const prevIndex=selectedIndex;games=arr;if(prevId){const nextIndex=games.findIndex(g=>g&&g.id===prevId);selectedIndex=nextIndex>=0?nextIndex:games.length?0:null;}else if(prevIndex!=null&&prevIndex<games.length){selectedIndex=prevIndex;}else if(games.length){selectedIndex=0;}else{selectedIndex=null;}renderList();renderEditor();syncTextarea();const results=[];const idToIndex=new Map();for(let i=0;i<arr.length;i++){const game=arr[i];const result={index:i,id:null,title:null,displayName:'Entry #'+(i+1),errors:[],warnings:[],resources:[]};results.push(result);if(!game||typeof game!=='object'){result.errors.push('Entry is not an object.');continue;}const idValue=typeof game.id==='string'?game.id.trim():'';if(idValue){result.id=idValue;if(idToIndex.has(idValue)){const firstIndex=idToIndex.get(idValue);result.errors.push(`Duplicate id "${idValue}" also used in entry #${firstIndex+1}`);const first=results[firstIndex];if(first&&!first.errors.some(msg=>msg.includes(`Duplicate id "${idValue}"`))){first.errors.push(`Duplicate id "${idValue}" also used in entry #${i+1}`);}}else{idToIndex.set(idValue,i);}}else{result.errors.push('Missing id');}const titleValue=typeof game.title==='string'?game.title.trim():'';if(titleValue){result.title=titleValue;}else{result.errors.push('Missing title');}result.displayName=titleValue||idValue||'Entry #'+(i+1);const descriptionValue=typeof game.description==='string'?game.description.trim():'';if(!descriptionValue){result.errors.push('Missing description');}const pathValue=typeof game.path==='string'?game.path.trim():'';if(pathValue){if(!/^\/?games\//.test(pathValue)){result.errors.push(`Path should begin with "games/": ${pathValue}`);}const pathUrl=toAbsoluteUrl(pathValue);if(pathUrl){result.resources.push({field:'path',url:pathUrl,raw:pathValue,severity:'error'});}else{result.errors.push(`Invalid path URL: ${pathValue}`);}}else{result.errors.push('Missing path');}if(game.thumb!=null){if(typeof game.thumb!=='string'){result.errors.push('Thumbnail path must be a string.');}else{const thumbValue=game.thumb.trim();if(!thumbValue){result.warnings.push('Thumbnail path is blank.');}else{if(!/^\/?assets\//.test(thumbValue)){result.errors.push(`Thumb should be under assets/: ${thumbValue}`);}const thumbUrl=toAbsoluteUrl(thumbValue);if(thumbUrl){result.resources.push({field:'thumb',url:thumbUrl,raw:thumbValue,severity:'warning'});}else{result.errors.push(`Invalid thumbnail URL: ${thumbValue}`);}}}}else{result.warnings.push('No thumbnail configured; emoji fallback will be used.');}if(!Array.isArray(game.tags)||game.tags.length===0){result.warnings.push('Tags missing or empty (affects tag filters).');}else if(game.tags.some(tag=>typeof tag!=='string'||!tag.trim())){result.warnings.push('Tags should only contain non-empty strings.');}if(typeof game.new==='undefined'){result.warnings.push('Missing "new" flag (defaults to PLAY badge).');}else if(typeof game.new!=='boolean'){result.warnings.push('"new" flag should be a boolean.');}if(typeof game.emoji!=='string'||!game.emoji.trim()){result.warnings.push('Emoji missing (fallback will be ðŸŽ®).');}else if(game.emoji.trim().length>4){result.warnings.push('Emoji should be at most 4 characters.');}if(typeof game.addedAt!=='string'||!game.addedAt.trim()){result.warnings.push('addedAt missing (used for new sorting).');}else{const addedAtValue=game.addedAt.trim();const isoPattern=/^\d{4}-\d{2}-\d{2}$/;if(!isoPattern.test(addedAtValue)||Number.isNaN(Date.parse(addedAtValue))){result.warnings.push(`addedAt should be YYYY-MM-DD; found ${addedAtValue}`);}}}await verifyResources(results);renderValidationReport(results);}catch(err){console.error('Validation failed',err);setValidationSummary('Validation failed: '+err.message,'error');resetValidationResults('See console for details.');}finally{validateBtn.disabled=false;validateBtn.textContent=originalLabel;}});
function dl(name,blob){const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();setTimeout(()=>URL.revokeObjectURL(a.href),1000)}
document.getElementById('backup').onclick=()=>{syncTextarea();dl('games.backup.json',new Blob([ed.value||'[]'],{type:'application/json'}));};
document.getElementById('saveJson').onclick=()=>{syncTextarea();dl('games.json',new Blob([ed.value],{type:'application/json'}));};
const drop=document.getElementById('drop');['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.background='rgba(255,255,255,0.06)'}));['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.background='transparent'}));
drop.addEventListener('drop',async e=>{
  const file=e.dataTransfer.files[0];
  if(!file)return;
  const zip=await JSZip.loadAsync(file);
  let prefix='';
  const folders=new Set();
  zip.forEach((p,f)=>{const seg=p.split('/');if(seg.length>1)folders.add(seg[0]);});
  if(folders.size===1)prefix=[...folders][0]+'/';
  const idx=zip.file(prefix+'index.html')||zip.file('index.html');
  if(!idx){alert('No index.html found');return}
  const name=file.name.replace(/\.zip$/i,'');
  const id=name.toLowerCase().replace(/[^a-z0-9]+/g,'-');
  const title=name;
  const tf=zip.file(prefix+'thumb.png')||zip.file(prefix+'thumbnail.png')||zip.file('thumb.png')||zip.file('thumbnail.png');
  let thumbPath='';
  if(tf)thumbPath='assets/thumbs/'+id+'.png';
  const existingIndex=games.findIndex(g=>g.id===id);
  if(existingIndex>=0){
    if(!confirm('Game id exists. Overwrite entry?'))return;
    games=games.filter(g=>g.id!==id);
    pendingAdds=pendingAdds.filter(it=>it.id!==id);
    imports.querySelectorAll(`[data-id="${id}"]`).forEach(el=>{if(el.previewState&&typeof el.previewState.destroy==='function')el.previewState.destroy();el.remove();});
  }
  const newEntry={id,title,path:`games/${id}/index.html`,description:'New uploaded game â€” update me!',tags:['new'],new:true,emoji:'ðŸŽ®',addedAt:new Date().toISOString().slice(0,10)};
  if(thumbPath)newEntry.thumb=thumbPath;
  games=[...games,newEntry];
  const record={id,zip,prefix,tf};
  pendingAdds.push(record);
  selectedIndex=games.findIndex(g=>g.id===id);
  renderList();
  renderEditor();
  syncTextarea();
  const card=document.createElement('div');
  card.className='mini import-card';
  card.dataset.id=id;
  const titleEl=document.createElement('h4');
  titleEl.textContent=title;
  card.appendChild(titleEl);
  const pillRow=document.createElement('div');
  pillRow.className='row';
  pillRow.style.gap='8px';
  const makePill=text=>{const span=document.createElement('span');span.className='pill';span.textContent=text;return span};
  pillRow.appendChild(makePill('id: '+id));
  pillRow.appendChild(makePill(`path: games/${id}/index.html`));
  if(tf)pillRow.appendChild(makePill('thumb âœ“'));
  card.appendChild(pillRow);
  const actions=document.createElement('div');
  actions.className='import-actions';
  const status=document.createElement('small');
  status.textContent='Files ready for export.';
  actions.appendChild(status);
  const previewBtn=document.createElement('button');
  previewBtn.type='button';
  previewBtn.className='btn';
  previewBtn.textContent='Preview';
  actions.appendChild(previewBtn);
  card.appendChild(actions);
  const previewWrap=document.createElement('div');
  previewWrap.className='preview-shell';
  previewWrap.hidden=true;
  const previewId=`preview-${id}-${Date.now()}`;
  previewWrap.id=previewId;
  const placeholder=document.createElement('div');
  placeholder.className='preview-placeholder';
  placeholder.textContent='Loading previewâ€¦';
  previewWrap.appendChild(placeholder);
  const frame=document.createElement('iframe');
  frame.setAttribute('title',`${title} preview`);
  frame.setAttribute('sandbox','allow-scripts allow-same-origin allow-pointer-lock allow-popups allow-forms');
  frame.setAttribute('loading','lazy');
  frame.allow='autoplay; fullscreen';
  previewWrap.appendChild(frame);
  const closeBtn=document.createElement('button');
  closeBtn.type='button';
  closeBtn.className='btn preview-close';
  closeBtn.textContent='Close';
  previewWrap.appendChild(closeBtn);
  card.appendChild(previewWrap);
  previewBtn.setAttribute('aria-controls',previewId);
  previewBtn.setAttribute('aria-expanded','false');
  const previewState={urls:[],active:false,token:null,cleanup(){this.urls.forEach(u=>URL.revokeObjectURL(u));this.urls=[];}};
  previewState.close=({skipFocus}={})=>{previewState.token=null;previewState.cleanup();frame.srcdoc='';previewWrap.classList.remove('active');previewWrap.hidden=true;placeholder.hidden=true;placeholder.textContent='Loading previewâ€¦';previewState.active=false;previewBtn.textContent='Preview';previewBtn.setAttribute('aria-expanded','false');previewBtn.disabled=false;if(!skipFocus)previewBtn.focus?.();};
  previewState.destroy=()=>{previewState.close({skipFocus:true});};
  card.previewState=previewState;
  closeBtn.addEventListener('click',()=>{previewState.close();});
  previewBtn.addEventListener('click',async()=>{
    if(previewState.active){
      previewState.close();
      return;
    }
    previewState.cleanup();
    const token=Symbol('preview');
    previewState.token=token;
    previewBtn.disabled=true;
    previewBtn.textContent='Loadingâ€¦';
    previewWrap.hidden=false;
    previewWrap.classList.add('active');
    placeholder.hidden=false;
    placeholder.textContent='Loading previewâ€¦';
    try{
      await loadPreviewIntoFrame(record,frame,previewState,placeholder,token);
      if(previewState.token!==token)return;
      previewState.active=true;
      previewBtn.textContent='Close preview';
      previewBtn.setAttribute('aria-expanded','true');
    }catch(err){
      if(previewState.token!==token)return;
      console.error('Preview failed for',id,err);
      frame.srcdoc='';
      previewState.cleanup();
      previewState.active=false;
      placeholder.hidden=false;
      placeholder.textContent='Preview failed to load. Check console for details.';
      previewWrap.hidden=false;
      previewWrap.classList.add('active');
      previewBtn.textContent='Preview';
      previewBtn.setAttribute('aria-expanded','false');
      previewState.token=null;
    }finally{
      previewBtn.disabled=false;
    }
  });
  imports.prepend(card);
});
document.getElementById('exportPatch').onclick=async()=>{syncTextarea();const out=new JSZip();out.file('games.json',ed.value);for(const it of pendingAdds){const base='games/'+it.id+'/';const entries=[];it.zip.forEach((p,f)=>{if(!f.dir)entries.push([p,f])});for(const [p,f] of entries){let rel=p.startsWith(it.prefix)?p.slice(it.prefix.length):p;if(!rel)continue;out.file(base+rel,await f.async('blob'))}if(it.tf)out.file('assets/thumbs/'+it.id+'.png',await it.tf.async('blob'))}const blob=await out.generateAsync({type:'blob'});dl('gurjots-games-patch.zip',blob)};
renderList();
renderEditor();
const qp=new URLSearchParams(location.search);if(qp.get('key')!=='letmein'){document.querySelectorAll('button, textarea, .drop').forEach(el=>el.classList.add('hide'));const warn=document.createElement('div');warn.className='status error';warn.textContent='Access denied. Append ?key=letmein to use this page.';document.body.prepend(warn)}
</script></body></html>
