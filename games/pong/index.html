<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pong Classic</title>
  <style>
    html, body{height:100%; margin:0; background:#0e0f12; color:#e6e6e6; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .wrap{display:grid; place-items:center; height:100%; padding:16px}
    canvas{background:#0a0d13; border:1px solid #1f2431; border-radius:12px; box-shadow:0 6px 22px rgba(0,0,0,.35)}
    .hud{position:fixed; top:12px; left:12px; background:#1b1e24c0; border:1px solid #27314b; border-radius:10px; padding:8px 10px; font-size:14px}
    kbd{padding:1px 6px; border-radius:6px; border:1px solid #2f3542; background:#111319; color:#d3d7de; font-weight:600; font-size:12px;}
  </style>
</head>
<body>
  <div class="hud">Move: <kbd>←</kbd><kbd>→</kbd> • Pause: <kbd>P</kbd></div>
  <div class="wrap">
    <canvas id="game" width="720" height="420" aria-label="Pong game"></canvas>
  </div>
  <script type="module">
    import { virtualButtons } from "../../shared/controls.js";
    import { injectBackButton } from "../../shared/ui.js";

    const cvs = document.getElementById('game');
    const ctx = cvs.getContext('2d');

    const W = cvs.width, H = cvs.height;
    const paddleW = 100, paddleH = 14, margin = 28;
    const player = { x: (W-paddleW)/2, y: H - margin - paddleH, vx: 0, speed: 520, score: 0 };
    const ai = { x: (W-paddleW)/2, y: margin, vx: 0, speed: 360, score: 0 };
    const ball = { x: W/2, y: H/2, r: 8, vx: 260, vy: 260 };
    let paused = false;

    const keys = new Map();
    addEventListener('keydown', e => { keys.set(e.code, true); if(e.code==='KeyP') paused = !paused; });
    addEventListener('keyup', e => keys.set(e.code, false));

    const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    if (isTouch) {
      virtualButtons({ left: true, right: true });
    }

    let last = 0;
    function loop(ts){
      const dt = Math.min((ts - last)/1000, 0.033);
      last = ts;
      if(!paused) update(dt);
      draw();
      requestAnimationFrame(loop);
    }

    function update(dt){
      // input
      const buttons = virtualButtons.read();
      const dir = ((keys.get('ArrowRight') || buttons.right)?1:0) - ((keys.get('ArrowLeft') || buttons.left)?1:0);
      player.vx = dir * player.speed;
      player.x += player.vx * dt;

      // constrain
      player.x = Math.max(0, Math.min(W - paddleW, player.x));

      // AI follows ball with dampened speed
      const target = ball.x - paddleW/2;
      const dx = target - ai.x;
      ai.vx = Math.max(-ai.speed, Math.min(ai.speed, dx * 5));
      ai.x += ai.vx * dt;
      ai.x = Math.max(0, Math.min(W - paddleW, ai.x));

      // ball movement
      ball.x += ball.vx * dt;
      ball.y += ball.vy * dt;

      // walls
      if (ball.x < ball.r) { ball.x = ball.r; ball.vx *= -1; }
      if (ball.x > W - ball.r) { ball.x = W - ball.r; ball.vx *= -1; }

      // paddle collisions
      if (ball.y + ball.r >= player.y && ball.y - ball.r <= player.y + paddleH && ball.x > player.x && ball.x < player.x + paddleW) {
        ball.y = player.y - ball.r;
        ball.vy = -Math.abs(ball.vy);
        // add spin based on where it hits the paddle
        const hit = (ball.x - (player.x + paddleW/2)) / (paddleW/2);
        ball.vx += hit * 180;
      }
      if (ball.y - ball.r <= ai.y + paddleH && ball.y + ball.r >= ai.y && ball.x > ai.x && ball.x < ai.x + paddleW) {
        ball.y = ai.y + paddleH + ball.r;
        ball.vy = Math.abs(ball.vy);
        const hit = (ball.x - (ai.x + paddleW/2)) / (paddleW/2);
        ball.vx += hit * 140;
      }

      // scoring
      if (ball.y < -20) { player.score++; resetBall(-1); }
      if (ball.y > H + 20) { ai.score++; resetBall(1); }
    }

    function resetBall(dir){
      ball.x = W/2; ball.y = H/2;
      const angle = (Math.random()*0.6 - 0.3); // -0.3..0.3 rad
      const speed = 360;
      ball.vx = Math.cos(angle) * speed;
      ball.vy = Math.sin(angle) * speed * dir;
    }

    function draw(){
      // clear
      ctx.clearRect(0,0,W,H);

      // midline
      ctx.fillStyle = '#1e2636';
      for(let y=0; y<H; y+=18){ ctx.fillRect(W/2 - 2, y, 4, 10); }

      // paddles
      ctx.fillStyle = '#e6eef9';
      ctx.fillRect(player.x, player.y, paddleW, paddleH);
      ctx.fillRect(ai.x, ai.y, paddleW, paddleH);

      // ball
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
      ctx.fill();

      // scores
      ctx.font = 'bold 32px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.textAlign = 'center'; ctx.fillStyle = '#cfe6ff';
      ctx.fillText(player.score, W/2 + 60, H/2 + 36);
      ctx.fillText(ai.score, W/2 - 60, H/2 - 16);
    }

    requestAnimationFrame(loop);
    injectBackButton();
  </script>
</body>
</html>
