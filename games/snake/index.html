<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Snake+</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --bg:#0b1020; --fg:#e8eefc; --muted:#9fb2d9; --accent:#6ea8fe; --danger:#ff6b6b; --good:#6ef7a8; --card:#111735; --border:#25305a; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{position:fixed;inset:0;display:grid;place-items:center;padding:10px}
    canvas{display:block;background:#0e163a;border:1px solid var(--border);border-radius:12px;max-width:100vw;max-height:100vh;image-rendering:pixelated; box-shadow:0 10px 40px rgba(0,0,0,.4)}
    .hud{position:fixed;top:10px;left:10px;display:flex;gap:10px;align-items:center;font-weight:700;flex-wrap:wrap}
    .pill{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .btn{cursor:pointer}
    .msg{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5)}
    .msg.show{display:grid}
    .panel{background:var(--card);border:1px solid var(--border);padding:16px 18px;border-radius:12px;text-align:left;max-width:520px;box-shadow:0 10px 40px rgba(0,0,0,.4)}
    .panel h2{margin:6px 0 10px}
    .panel .row{display:flex;gap:10px;justify-content:flex-end}
    .panel .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#0b122f;color:var(--fg);cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="640" height="480" aria-label="Snake game"></canvas>
  </div>

  <div class="hud" aria-live="polite">
    <div class="pill">Score: <span id="score">0</span></div>
    <div class="pill">Best: <span id="best">0</span></div>
    <div class="pill">Level: <span id="level">1</span></div>
    <div class="pill">Length: <span id="len">1</span></div>
    <div class="pill btn" id="pause" title="Pause (Space)">⏸ Pause</div>
    <div class="pill btn" id="restart" title="Restart (R)">⟲ Restart</div>
  </div>

  <div class="msg" id="overlay">
    <div class="panel">
      <h2 id="overlay-title">Paused</h2>
      <p id="overlay-sub">Press <b>Space</b> or tap Resume.</p>
      <div class="row">
        <button class="btn" id="resumeBtn">▶ Resume</button>
        <button class="btn" id="restartBtn">⟲ Restart</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);
    const canvas = $('#game'), ctx = canvas.getContext('2d');
    const CELL = 20; let cols=32, rows=24;
    function fit(){
      const maxW = Math.min(window.innerWidth-20, 1100);
      const maxH = Math.min(window.innerHeight-20, 820);
      const scale = Math.max(1, Math.min(Math.floor(maxW/(cols*CELL)), Math.floor(maxH/(rows*CELL))));
      canvas.width = cols*CELL; canvas.height = rows*CELL;
      canvas.style.width = (cols*CELL*scale)+'px'; canvas.style.height = (rows*CELL*scale)+'px';
    }
    window.addEventListener('resize', fit);

    const DIRS={left:{x:-1,y:0}, right:{x:1,y:0}, up:{x:0,y:-1}, down:{x:0,y:1}};
    let snake, dir, nextDir, food, speed, tickMs, score, best=0, paused=false, dead=false, lastTs=0, level=1, len=1;
    function reset(){
      fit();
      snake=[{x:Math.floor(cols/2), y:Math.floor(rows/2)}];
      dir=DIRS.right; nextDir=dir; spawnFood();
      score=0; level=1; len=1; speed=7; tickMs=1000/speed;
      paused=false; dead=false; lastTs=performance.now();
      $('#score').textContent='0'; $('#level').textContent='1'; $('#len').textContent='1';
      try{ best=Math.max(Number(localStorage.getItem('snake_plus_best')||'0'),0); $('#best').textContent=String(best);}catch(_){}
      hideOverlay();
    }
    function spawnFood(){ while(true){ const fx=Math.floor(Math.random()*cols), fy=Math.floor(Math.random()*rows); if(!snake.some(s=>s.x===fx&&s.y===fy)){ food={x:fx,y:fy}; return; } } }
    function enqueueDir(d){ if((d.x+dir.x)===0&&(d.y+dir.y)===0) return; nextDir=d; }
    window.addEventListener('keydown', e=>{ const k=e.key.toLowerCase();
      if (k==='arrowleft'||k==='a') enqueueDir(DIRS.left);
      else if (k==='arrowright'||k==='d') enqueueDir(DIRS.right);
      else if (k==='arrowup'||k==='w') enqueueDir(DIRS.up);
      else if (k==='arrowdown'||k==='s') enqueueDir(DIRS.down);
      else if (k===' ') togglePause();
      else if (k==='r') hardRestart();
      if (['arrowleft','arrowright','arrowup','arrowdown',' '].includes(k)) e.preventDefault();
    });
    $('#pause').onclick = togglePause; $('#restart').onclick = hardRestart; $('#resumeBtn').onclick = togglePause; $('#restartBtn').onclick = hardRestart;

    function togglePause(){ if (dead) return; paused=!paused; if (paused){ showOverlay('Paused','Press Space or tap Resume'); } else { hideOverlay(); lastTs=performance.now(); requestAnimationFrame(loop);} }
    function hardRestart(){ reset(); render(); requestAnimationFrame(loop); }
    function showOverlay(title, sub){ $('#overlay-title').textContent=title||'Paused'; $('#overlay-sub').textContent=sub||''; $('#overlay').classList.add('show'); }
    function hideOverlay(){ $('#overlay').classList.remove('show'); }
    function drawCell(x,y,c){ ctx.fillStyle=c; ctx.fillRect(x*CELL,y*CELL,CELL,CELL); }
    function render(){
      ctx.fillStyle='#0e163a'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=1;
      for(let x=0;x<=cols;x++){ ctx.beginPath(); ctx.moveTo(x*CELL+0.5,0); ctx.lineTo(x*CELL+0.5,rows*CELL); ctx.stroke(); }
      for(let y=0;y<=rows;y++){ ctx.beginPath(); ctx.moveTo(0,y*CELL+0.5); ctx.lineTo(cols*CELL,y*CELL+0.5); ctx.stroke(); }
      drawCell(food.x, food.y, '#6ef7a8');
      for(let i=0;i<snake.length;i++){ const seg=snake[i]; drawCell(seg.x,seg.y, i===0? '#6ea8fe':'#9fb2d9'); }
    }
    function step(){
      dir = nextDir;
      const head = snake[0]; let nx=head.x+dir.x, ny=head.y+dir.y;
      if (nx<0) nx=cols-1; else if (nx>=cols) nx=0;
      if (ny<0) ny=rows-1; else if (ny>=rows) ny=0;
      if (snake.some((s,i)=>i>0&&s.x===nx&&s.y===ny)){ dead=true; showOverlay('Game Over','Press R to restart'); return; }
      snake.unshift({x:nx,y:ny});
      if (nx===food.x && ny===food.y){ score+=1; len+=1; $('#score').textContent=String(score); $('#len').textContent=String(len); spawnFood(); if (score%5===0){ level+=1; $('#level').textContent=String(level); speed=Math.min(14, speed+1); tickMs=1000/speed; } }
      else { snake.pop(); }
    }
    function loop(ts){
      if (paused||dead) return;
      if (ts-lastTs>=tickMs){ lastTs=ts; step(); render(); }
      requestAnimationFrame(loop);
    }
    reset(); render(); requestAnimationFrame(loop);
    try { parent && parent.postMessage({ type:'GAME_READY' }, '*'); } catch(_){ }
  })();
  </script>
  <script src="../common/diag-upgrades.js" defer data-slug="snake"></script>
</body>
</html>
