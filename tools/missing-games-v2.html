<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Missing Games Checker v2</title>
<style>
  :root{--bg:#0b0f1a;--fg:#e6edf3;--muted:#9aa4b2;--bad:#ff6b6b;--ok:#8de77b;--warn:#ffd166;--card:#111726;}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Ubuntu;color:var(--fg);background:radial-gradient(900px 600px at 50% -150px,#162042,var(--bg));}
  header{padding:1rem 1.25rem;background:linear-gradient(180deg,#0f1730,var(--card));border-bottom:1px solid #1b2440;}
  h1{margin:0;font-size:1.25rem}
  main{padding:1rem 1.25rem;max-width:1100px;margin:auto}
  .row{display:grid;grid-template-columns:1fr auto auto auto;gap:.75rem;align-items:center;padding:.6rem .75rem;border:1px solid #1b2440;background:#0f1426;border-radius:.75rem;margin:.5rem 0}
  .slug{font-weight:700}
  .status.ok{color:var(--ok)} .status.missing{color:var(--bad)} .status.warn{color:var(--warn)}
  .small{color:var(--muted);font-size:.9rem}
  code{background:#0b1120;border:1px solid #1b2440;padding:.1rem .35rem;border-radius:.35rem}
  .legend{display:flex;gap:1rem;margin:1rem 0}
  .bar{margin-top:1rem;opacity:.85}
  .card{padding:1rem;border:1px solid #1b2440;background:#0f1426;border-radius:.75rem;margin:1rem 0}
  .controls{display:flex;flex-wrap:wrap;gap:.5rem;margin:.5rem 0}
  textarea{width:100%;min-height:100px;background:#0b1120;color:var(--fg);border:1px solid #1b2440;border-radius:.5rem;padding:.5rem}
  button{background:#6ea8fe;color:#081121;border:none;padding:.5rem .8rem;border-radius:.5rem;font-weight:600;cursor:pointer}
  .hr{height:1px;background:#1b2440;margin:1rem 0}
  .pill{display:inline-flex;gap:.35rem;align-items:center;background:#0b1120;border:1px solid #1b2440;border-radius:999px;padding:.25rem .5rem;font-size:.8rem}
  .k{color:#9bd}
  .v{color:#b9f}
  pre{white-space:pre-wrap;word-break:break-word;background:#0b1120;border:1px solid #1b2440;padding:.5rem;border-radius:.5rem;max-height:300px;overflow:auto}
</style>
</head>
<body>
<header>
  <h1>Missing Games Checker v2</h1>
  <div class="small bar">Checks <code>games.json</code> vs. each game's resolved <code>playUrl</code> (fallback: <code>/games/&lt;slug&gt;/index.html</code>). Now with multi-path lookup + paste fallback.</div>
</header>
<main>
  <div class="legend small">
    <div><span class="status ok">●</span> OK: index.html found</div>
    <div><span class="status missing">●</span> Missing: 404 or not reachable</div>
    <div><span class="status warn">●</span> Warn: Non-200/404 (e.g., 500/CORS)</div>
  </div>

  <div class="card">
    <div class="small">Lookup order for <code>games.json</code>:</div>
    <div class="controls">
      <span class="pill"><span class="k">1</span><span class="v">../games.json</span></span>
      <span class="pill"><span class="k">2</span><span class="v">./games.json</span></span>
      <span class="pill"><span class="k">3</span><span class="v">/games.json</span></span>
      <span class="pill"><span class="k">4</span><span class="v">../assets/games.json</span></span>
      <span class="pill"><span class="k">5</span><span class="v">../public/games.json</span></span>
    </div>
    <div class="controls">
      <button id="btn-load">Load from games.json</button>
      <button id="btn-clear">Clear results</button>
    </div>
    <div id="json-info" class="small"></div>
    <div id="json-preview"></div>
  </div>

  <div class="card">
    <div class="small">Or paste slugs (comma/space/newline separated), or a JSON array/object with slug fields:</div>
    <textarea id="manual" placeholder="e.g. pong,snake,tetris  OR  [{&quot;slug&quot;:&quot;pong&quot;},{&quot;id&quot;:&quot;snake&quot;}]"></textarea>
    <div class="controls">
      <button id="btn-run">Run check on pasted list</button>
    </div>
  </div>

  <div id="list"></div>
</main>
<script type="module">
import { resolveGamePaths } from '../shared/game-paths.js';
const list = document.getElementById('list');
const jsonInfo = document.getElementById('json-info');
const jsonPreview = document.getElementById('json-preview');

const fallbackPathForSlug = (slug) => `/games/${slug}/index.html`;

async function resolvePath(slug) {
  const cleanSlug = (slug || '').trim();
  if (!cleanSlug) return fallbackPathForSlug('unknown');
  try {
    const { playPath } = await resolveGamePaths(cleanSlug);
    if (playPath) return playPath;
  } catch (err) {
    console.warn('[GG][missing-games-v2] Unable to resolve play path for slug', slug, err);
  }
  return fallbackPathForSlug(cleanSlug);
}

function clearResults(){ list.innerHTML = ''; }

function preview(obj){
  const s = JSON.stringify(obj, null, 2);
  jsonPreview.innerHTML = '<pre>'+s.slice(0, 1200) + (s.length>1200 ? '\n…(truncated)…' : '') + '</pre>';
}

function normalizeToSlugs(data){
  const slugs = [];
  if (!data) return slugs;
  const pushMaybe = (s) => { if (s && typeof s === 'string') slugs.push(s.trim()); };

  if (Array.isArray(data)){
    for (const g of data){
      if (typeof g === 'string'){ pushMaybe(g); continue; }
      if (!g || typeof g !== 'object') continue;
      pushMaybe(g.slug || g.id || g.name || (g.path && String(g.path).split('/').filter(Boolean).slice(-2,-1)[0]));
    }
  } else if (data && typeof data === 'object'){
    // object map or {games:[...]}
    if (Array.isArray(data.games)) return normalizeToSlugs(data.games);
    // treat keys as slugs
    for (const k of Object.keys(data)){ pushMaybe(k); }
  }
  return slugs.filter(Boolean);
}

async function probe(url){
  try {
    const res = await fetch(url, { method: 'HEAD', cache: 'no-store' });
    if (res.status === 200) return {status:'ok', code:200};
    if (res.status === 404) return {status:'missing', code:404};
    return {status:'warn', code:res.status};
  } catch (e) { return {status:'warn', code:'ERR'}; }
}

function row(slug, path, out){
  const div = document.createElement('div');
  div.className = 'row';
  div.innerHTML = \`
    <div class="slug">\${slug}</div>
    <div class="small">\${path}</div>
    <div class="status \${out.status}">\${out.status.toUpperCase()}</div>
    <div class="small">\${out.code}</div>
  \`;
  return div;
}

async function runForSlugs(slugs){
  if (!slugs.length){
    const div = document.createElement('div');
    div.className = 'row';
    div.innerHTML = '<div class="slug">No slugs found</div><div class="small">Provide games.json or paste list above.</div><div class="status warn">WARN</div><div class="small">N/A</div>';
    list.append(div);
    return;
  }
  for (const slug of slugs){
    const cleanSlug = (slug || '').trim();
    const label = cleanSlug || '(unknown)';
    const path = await resolvePath(cleanSlug);
    const out = await probe(path);
    list.append(row(label, path, out));
  }
}

async function loadFromCandidates(){
  clearResults();
  jsonInfo.textContent = 'Loading games.json…';
  const cands = ['../games.json','./games.json','/games.json','../assets/games.json','../public/games.json'];
  let lastErr = '';
  for (const url of cands){
    try{
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) { lastErr = url + ' → ' + res.status; continue; }
      const data = await res.json();
      const slugs = normalizeToSlugs(data);
      jsonInfo.textContent = 'Loaded from ' + url + ' • ' + slugs.length + ' slug(s)';
      preview(data);
      await runForSlugs(slugs);
      return;
    }catch(e){ lastErr = url + ' → ERR'; }
  }
  jsonInfo.textContent = 'Failed to load games.json from all candidates. Last error: ' + lastErr;
  preview({ error: 'No games.json found at any candidate path.' });
  await runForSlugs([]);
}

document.getElementById('btn-load').addEventListener('click', loadFromCandidates);
document.getElementById('btn-clear').addEventListener('click', () => { clearResults(); jsonInfo.textContent=''; jsonPreview.textContent=''; });
document.getElementById('btn-run').addEventListener('click', async () => {
  clearResults();
  jsonInfo.textContent = 'Using pasted list';
  let text = document.getElementById('manual').value.trim();
  let slugs = [];
  try {
    if (text.startsWith('[') || text.startsWith('{')){
      const data = JSON.parse(text);
      slugs = normalizeToSlugs(data);
    } else {
      slugs = text.split(/\s|,|;|\n|\r/).map(s=>s.trim()).filter(Boolean);
    }
  } catch (e) {
    jsonInfo.textContent = 'Could not parse pasted JSON. Falling back to split by commas/space/newlines.';
    slugs = text.split(/\s|,|;|\n|\r/).map(s=>s.trim()).filter(Boolean);
  }
  preview({ inputCount: slugs.length, sample: slugs.slice(0,10) });
  await runForSlugs(slugs);
});

// auto-try on load once, but don't fail silently—show details
loadFromCandidates();
</script>
</body>
</html>
