import { readFile, writeFile } from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';
import { normalizeCatalogEntries, toNormalizedList } from '../shared/game-catalog-core.js';

const rootDir = path.resolve(path.dirname(fileURLToPath(import.meta.url)), '..');
const gamesPath = path.join(rootDir, 'games.json');
const offlinePath = path.join(rootDir, 'data', 'games-offline.js');
const normalizedPath = path.join(rootDir, 'data', 'games-normalized.json');
const publicGamesPath = path.join(rootDir, 'public', 'games.json');

async function readGames() {
  const source = await readFile(gamesPath, 'utf8');
  const parsed = JSON.parse(source);
  if (!Array.isArray(parsed)) {
    throw new Error('games.json must contain an array');
  }
  return parsed;
}

function buildOfflineModule(games) {
  const header = '// Auto-generated by tools/sync-game-catalog.mjs. Do not edit manually.\n';
  const body = `export const games = ${JSON.stringify(games, null, 2)};\nexport default games;\n`;
  return header + body;
}

async function main() {
  const games = await readGames();
  const normalized = normalizeCatalogEntries(games);
  const normalizedList = toNormalizedList(normalized);

  await writeFile(offlinePath, buildOfflineModule(games));
  await writeFile(normalizedPath, JSON.stringify({ games: normalizedList }, null, 2) + '\n');
  await writeFile(publicGamesPath, JSON.stringify(games, null, 2) + '\n');

  console.log('Game catalog artifacts updated.');
}

main().catch(err => {
  console.error(err);
  process.exitCode = 1;
});
